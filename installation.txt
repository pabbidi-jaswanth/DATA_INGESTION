"""
Router: SQL-first for fees/programs/eligibility/documents/scholarships/hostel.
Terse tables + tiny bullets. FAISS fallback only for long-form explainers.
"""

from app.sql_router import (
    detect_structured_intent, parse_filters,
    sql_hostel_overview, sql_block_contacts, sql_list_blocks,
    sql_programs, sql_eligibility, sql_documents, sql_academic_fees, sql_scholarships
)

def _fmt_table(tbl: dict) -> str:
    if not tbl or not tbl.get("rows"):
        return "_No matching rows._"
    title  = f"**{tbl.get('title','Results')}**"
    cols   = tbl["columns"]
    header = " | ".join(cols)
    sep    = " | ".join(["---"]*len(cols))
    lines  = [title, "", header, sep]
    for r in tbl["rows"]:
        lines.append(" | ".join(str(x) if x is not None else "" for x in r))
    return "\n".join(lines)

def _fmt_bullets(bullets: list[str]) -> str:
    return "\n".join(f"- {b}" for b in bullets) if bullets else ""

def _pack(table_dict=None, bullets=None):
    parts = []
    if table_dict: parts.append(_fmt_table(table_dict))
    if bullets:    parts.append(_fmt_bullets(bullets))
    return "\n\n".join(parts) if parts else "_No results._"

def _sql_route(q: str) -> str | None:
    intent = detect_structured_intent(q)
    f = parse_filters(q)

    # HOSTEL
    if intent == "contacts":
        return _pack(sql_block_contacts(f).get("table"))
    if intent == "blocks":
        return _pack(sql_list_blocks(f).get("table"))
    if intent in ("hostel", "tabular"):
        return _pack(sql_hostel_overview(f).get("table"))

    # ACADEMICS
    if intent == "programs":
        return _pack(sql_programs(f, q).get("table"))
    if intent == "eligibility":
        return _pack(sql_eligibility(f, q).get("table"))
    if intent == "documents":
        return _pack(sql_documents(f, q).get("table"))
    if intent == "fees":
        return _pack(sql_academic_fees(f, q).get("table"))
    if intent == "scholarships":
        return _pack(sql_scholarships(f, q).get("table"))

    return None

def answer(query: str) -> str:
    sql_text = _sql_route(query)
    if sql_text is not None:
        return sql_text

    # FAISS fallback (tight + sourcey)
    try:
        from app.utils.fallback_rag import answer as rag_fallback
        rag = rag_fallback(query, max_chunks=6, max_tokens=450)
        return rag or "_I couldn't find that in my sources._"
    except Exception:
        return "_I couldn't find that in my sources._"

if __name__ == "__main__":
    import sys
    q = " ".join(sys.argv[1:]) or "Show MH Senior NRI hostel fees 2025"
    print(answer(q))
