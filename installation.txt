# Stage HOSTEL PDFs â†’ CSVs (Data/staging) for eyeballing before SQLite load.
import pathlib, csv

IN  = pathlib.Path("Data/Raw/HOSTEL")
OUT = pathlib.Path("Data/staging"); OUT.mkdir(parents=True, exist_ok=True)

PDFS = [
  "MH-Senior-FEE-structure-Indian-NRI-FOREIGN-Category-2025-26.pdf",
  "MH-First-Year-FEE-structure-Indian-NRI-FOREIGN-Category-2025-26.pdf",
  "LH-FEE-structure-Indian-Category-2025-26.pdf",
  "LH-FEE-structure-NRI-Foreign-Category-2025-26.pdf",
  "Hostel_info.pdf",
  "Hostel-joint-Affidavit-2025.pdf",
]

def try_camelot(pdf_path: pathlib.Path):
    try:
        import camelot
    except Exception:
        return []
    tables = []
    try:
        t = camelot.read_pdf(str(pdf_path), pages='all', flavor='lattice')
        for i, table in enumerate(t):
            tables.append(("camelot", i, table.df))
    except Exception:
        pass
    return tables

def try_pdfplumber(pdf_path: pathlib.Path):
    import pdfplumber
    tables = []
    try:
        with pdfplumber.open(str(pdf_path)) as pdf:
            for pi, page in enumerate(pdf.pages):
                try:
                    for ti, rows in enumerate(page.extract_tables() or []):
                        tables.append(("pdfplumber", f"{pi}_{ti}", rows))
                except Exception:
                    pass
    except Exception:
        pass
    return tables

def normalize_df(df):
    rows = [list(df.columns)]
    for _, r in df.iterrows(): rows.append([str(x) for x in r.tolist()])
    return rows

def write_csv(rows, out_csv: pathlib.Path):
    with out_csv.open("w", newline="", encoding="utf-8") as f:
        w = csv.writer(f); [w.writerow([c.strip() if isinstance(c, str) else c for c in r]) for r in rows]

def main():
    for pdf_name in PDFS:
        pdf_path = IN / pdf_name
        if not pdf_path.exists():
            print(f"[WARN] Missing {pdf_path}"); continue

        staged = False
        for src, tag, obj in (try_camelot(pdf_path) or []):
            out_csv = OUT / f"{pdf_path.stem}__{src}_{tag}.csv"
            write_csv(normalize_df(obj), out_csv); print(f"[STAGED] {out_csv}"); staged = True

        if not staged:
            for src, tag, rows in (try_pdfplumber(pdf_path) or []):
                out_csv = OUT / f"{pdf_path.stem}__{src}_{tag}.csv"
                write_csv(rows, out_csv); print(f"[STAGED] {out_csv}"); staged = True

        if not staged: print(f"[FAIL] No tables detected in {pdf_path}")

if __name__ == "__main__":
    main()
